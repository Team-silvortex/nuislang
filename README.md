# 🪶 **NuisLang Whitepaper v0.42**

### A Semantics-First Execution Model for Heterogeneous Systems

**MIT License**

---

# 0. 引言 · 为什么需要新的执行模型

计算平台正在发生结构性变化：

* 单一 CPU 不再是中心
* GPU / NPU / WASM / 专用加速器成为常态
* 数据迁移成本正在超过计算成本
* 执行位置、生命周期、调度策略成为一等问题

然而，**主流语言的核心假设仍然停留在单域、同步、CPU 优先的时代**。

Nuis 并非试图“取代”现有语言。
它的目标更明确，也更克制：

> **为异构计算时代提供一个长期稳定的语义执行模型，
> 将“程序做什么”与“如何在哪执行”彻底解耦。**

Nuis 关注的是 **执行模型的可持续性**，而非短期平台适配。

---

# 1. 设计原则（Design Principles）

Nuis 的设计建立在三条长期稳定轴之上：

| 维度         | 含义           | 目标   |
| ---------- | ------------ | ---- |
| **语义稳定性**  | 程序“意图”不随硬件变化 | 长期不变 |
| **执行可替换性** | 执行策略可随时代演进   | 可演化  |
| **调度可分析性** | 调度与资源行为可静态推导 | 可验证  |

### 核心原则

1. **用户描述意图，而非执行路径**
2. **调度与位置是系统责任**
3. **语义优先于性能优化**
4. **安全来自一致的语义模型**
5. **IR 是系统边界，而非语言语法**

---

# 2. NIR：语义意图表示（Semantic Intent IR）

NIR（Nuis Intent Representation）是 Nuis 的最高层表示。

NIR 仅描述：

* 程序的**语义意图**
* 操作之间的**逻辑关系**
* 抽象资源的使用方式

**NIR 不包含：**

* 执行域（CPU / GPU）
* 生命周期细节
* 调度策略
* 内存布局

示例：

```nuis
let buf = Buffer<f32>(1024)
buf.fill(1.0)
buf.normalize()
```

在 NIR 中表示为：

* Allocate(1024)
* Fill(1.0)
* Normalize()

NIR 是 **“程序意义”的最小不变量**。

---

# 3. YIR：跨域调度图（Cross-Domain Scheduling IR）

YIR 是 Nuis 的核心执行表示。

YIR 将 NIR 的语义映射为一个 **跨执行域的调度图**：

* 节点（Node）：计算单元
* 边（Edge）：数据或控制依赖
* 资源（Res）：跨节点共享的对象

**YIR 是一个有向无环图（DAG）**，用于：

* CPU / GPU / WASM 的协同调度
* 数据流与控制流的统一建模
* 执行域映射与迁移决策
* 生命周期与资源一致性分析

---

# 4. GLM：图生命周期模型（Graph Lifetime Model）

GLM 定义了 YIR 层的正式资源语义。

## 4.1 值分类

### `val`

* SSA 中间值
* 不跨节点
* 不进入生命周期分析

### `res`

* 资源型对象（Buffer / Image / Tensor / Handle）
* 可跨节点、跨域存在
* 必须受 GLM 管理

---

## 4.2 资源使用模式（UseMode）

* **Own**：唯一所有权
* **Write**：独占可变访问
* **Read**：共享只读访问

约束规则：

* 任意时刻仅允许一个 Own
* Write 不可并发
* Read 可并发

---

## 4.3 生命周期区域（Region）

Region 表示一个资源在整个执行图中的合法使用区间。

非法情形包括：

* 定义前使用
* Drop 后使用
* 重复所有权
* 跨域未迁移即访问

这些问题 **在编译期静态检测**。

---

## 4.4 跨域迁移（Domain Move）

```text
send %buf -> GPU
```

表示：

* 所有权从 CPU 迁移至 GPU
* 生命周期区域随之扩展
* 源域立即失效

---

# 5. Domain IR：物理特化层

YIR 可被特化为不同执行域的 Domain IR：

* **CPU IR**：对应 Rust MIR / LLVM
* **GPU IR**：结构化计算 IR（SPIR-V / CUDA / Metal）
* **Shader IR**：图形流水线特化表示
* **WASM IR**：安全沙箱执行

---

# 6. Nurs：YIR-CPU ↔ Rust MIR 语义桥

Nurs 提供 YIR-CPU 与 Rust MIR 之间的双向映射：

* 无 C ABI
* 无绑定层
* 语义对齐而非接口对齐

YIR 是主轴，Rust MIR 是可替换后端之一。

---

# 7. Yalivia Runtime：执行与扩展层

Yalivia 是 Nuis 的可选运行时组件，用于：

* 动态调度
* 多语言接入（Go / Python / Lua）
* 异构执行实验
* 策略学习与调度探索

**Nuis 核心不依赖 Yalivia。**

---

# 8. 安全模型

安全由三层保证：

1. **GLM**：跨域资源一致性
2. **Nurs**：IR 语义一致性
3. **Rust**：CPU 地址级安全

---

# 9. 当前状态（v0.42）

| 模块   | 状态   |
| ---- | ---- |
| NIR  | 设计稳定 |
| YIR  | 结构稳定 |
| GLM  | 语义冻结 |
| Nurs | 路径明确 |
| 工具链  | 架构完成 |

---

# 10. 路线图

* **v0.5**：YIR 可执行原型
* **v0.6**：Nurs 原型
* **v0.7**：异构调度验证
* **v1.0**：稳定执行模型发布

---

# 结语

Nuis 不试图成为“下一门主流语言”。

它的目标更简单，也更困难：

> **在硬件持续变化的前提下，
> 保持程序语义长期成立。**

---

