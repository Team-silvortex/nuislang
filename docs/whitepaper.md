# 🧩 Nuis 工具链架构总览（v0.1）

> “语言即系统，工具链即语言的操作系统。”

---

## 一、整体分层结构

```
┌─────────────────────────────────────────────┐
│                Developer Layer              │
│  ─────────────────────────────────────────  │
│  nuis cli / gui / tui / LSP / IDE plugins   │
│  └── 高层命令接口、编译触发、守护通信         │
└─────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────┐
│             Nuis Runtime Core (nuis-rc)     │
│  守护进程、资源缓存、插件注册、项目沙箱管理   │
│  - YAML 配置解析                            │
│  - 插件注册（Nustar API）                   │
│  - 版本锁定 / ABI 管理                      │
│  - 资源缓存与沙箱快照                       │
└─────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────┐
│          Compiler Frontend (nuisc)          │
│  - 词法 / 语法 / 语义 / 类型检查            │
│  - AST 构建与域内分派                       │
│  - Comptime / Trait / Event 解析            │
│  - IR 生成与域下发（cpu/shader/kernel 等）  │
└─────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────┐
│          Domain Backends (via Nustar)       │
│  - CPU / SHADER / KERNEL / NPU / QUANTUM    │
│  - 各自的 IR Lower / Codegen 模块           │
│  - shader → WGSL/SPIR-V                     │
│  - kernel → PTX / Metal / OpenCL / ROCm     │
│  - cpu → LLVM IR / Cranelift / MIR          │
│  - npu/quantum → 插件提供后端               │
└─────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────┐
│           Nurs Layer (Rust bridge)          │
│  - 对接 OS / Filesystem / Drivers           │
│  - FFI 统一桥（Nurs ABI）                   │
│  - 安全封装、底层高性能组件                 │
│  - 负责内存、线程、IO、调度、FFI调用        │
└─────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────┐
│          Host OS (Linux / Win / macOS / WASI)│
│  - 文件系统、进程、驱动、系统调用            │
└─────────────────────────────────────────────┘
```

---

## 二、核心组件

### 1️⃣ **nuis（CLI / GUI / TUI）**

* 面向用户的前端入口。
* 管理项目、插件、工具链、沙箱。
* 类似 Rustup + Cargo + Docker 的综合体。
* 可脱机运行，支持 U 盘迁移。

**命令摘要：**

```
nuis build / run / test / fmt
nuis plugin add/remove
nuis sandbox up/stop
nuis cache clean
```

---

### 2️⃣ **nuis-rc（Runtime Core 守护）**

* 单例后台进程（per-project sandbox）。
* 管理：

  * 插件生命周期；
  * 全局/项目缓存；
  * 资源注册；
  * 守护 I/O；
  * 项目 ABI 隔离。
* 响应编译器的查询请求。

**特征：**

* YAML 配置驱动；
* 延迟加载插件；
* 支持长驻守护与自动停止；
* 项目关闭时自动释放资源。

---

### 3️⃣ **nuisc（Compiler）**

* 完整的语言编译器：

  * **前端：** BNF → AST → 语义树；
  * **中间层：** Domain IR；
  * **后端：** 多域 Lower。
* 支持：

  * `comptime` 编译期执行；
  * trait 泛型与 impl；
  * async/await；
  * event/on/emit；
  * 内联 shader/kernel。

输出产物：

* `.nir`（Nuis IR 快照）
* `.nbin`（可执行中间体）
* `.ncache`（语义缓存）

---

### 4️⃣ **Nustar 插件系统**

> “域是插件，插件是语言的扩展。”

* 允许注册自定义域（如 `audio`、`ai`、`physics`）。
* 每个插件定义：

  * AST 扩展；
  * IR Lower；
  * 后端生成器；
  * ABI 适配；
  * 语义验证。
* 插件通过 YAML 声明注册，守护进程动态加载。

```yaml
modules:
  - name: "audio"
    plugin: "nustar-audio"
    backend: "cpu"
```

---

### 5️⃣ **Nurs 层（Rust 桥）**

* 语言与操作系统之间的唯一通道；
* 提供统一 ABI；
* 所有 IO / 文件 / 线程 / GPU 调度都通过它；
* 类似 JVM 的 JNI，但静态、安全、零 GC；
* 允许开发者用 Rust 扩展性能模块。

**设计目标：**

* 最小 ABI；
* 零 unsafe；
* 稳定跨平台；
* 与 WASI 无缝对接。

---

### 6️⃣ **缓存与包系统**

分层缓存策略：

* **全局包缓存**：标准库与常用包只读共享；
* **项目缓存**：增量构建与依赖缓存；
* **插件缓存**：编译后自动注册的扩展。

**规则：**

* 项目不能写入全局包；
* nuis-rc 统一下载、版本锁定；
* ABI 变化自动重新构建。

---

### 7️⃣ **沙箱系统**

* 每个项目是一个“微系统”；
* 所有编译、运行、缓存都在隔离空间内；
* 可移动、可快照、可并行运行；
* 支持手动 `nuis sandbox stop` 关闭；
* 支持多平台迁移。

---

## 三、数据流与执行流程

```text
用户代码 → nuis build →
  nuis-rc 读取配置 →
    注册域 / 插件 →
      调用 nuis 编译器 →
        AST → NIR → Lower →
          调用对应后端（通过 Nustar） →
            生成目标代码（LLVM/WGSL/PTX/…） →
              链接 Nurs ABI →
                生成沙箱执行单元 →
                  nuis run 启动 → nuis-rc 调度执行
```

执行时：

* nuis-rc 监控所有 mod 的生命周期；
* 根据事件（event/emit）驱动不同域任务；
* shader/kernel 任务可并行调度；
* 所有资源受项目沙箱隔离；
* 退出时写回缓存索引。

---

## 四、工具链哲学（核心设计信条）

| 原则           | 说明                                  |
| ------------ | ----------------------------------- |
| **语言即系统**    | 编译器构建语义世界，而非生成程序                    |
| **模块即域**     | 每个 mod 是独立计算域（cpu/shader/kernel/…）  |
| **编译期强于运行期** | comptime 能力最大化，减少运行期复杂度             |
| **宿主即桥梁**    | OS 只是物理层，Nuis 自主管理语义层               |
| **无全局副作用**   | 一切通过 event/emit、trait、ref/copy 显式传递 |
| **生态即插件**    | 不修改编译器即可扩展语言语义                      |
| **AI 可读性优先** | 语义统一，结构清晰，方便 AI 与人类共同维护             |

---

## 五、终局目标：语言操作系统（LanguageOS）

> “Rust 控制硬件，Nuis 控制语义。”

未来形态：

* **Nuis = 一个可移植的语言系统内核**；
* 所有 Nuis 项目都是 **独立的微系统**；
* Nurs 负责硬件抽象；
* Nustar 负责领域抽象；
* nuis-rc 管理生命周期；
* nuis CLI 则是这个“语言操作系统”的 Shell。

最终形式：

```
┌──────────────────────────────────────────────┐
│                Nuis System                   │
│    ├── nuis-cli / GUI                        │
│    ├── nuis-rc (守护)                        │
│    ├── nuis-compiler (语义系统)              │
│    ├── nurs-abi (硬件桥)                     │
│    └── nustar-modules (领域插件)             │
└──────────────────────────────────────────────┘
```

---

## ✅ 总结一句话

> **Nuis 是一个以语言为核心的操作系统，不是运行在系统上的语言。**
> 每一个 `.nuis` 文件，不只是代码，而是语义系统的一部分。

